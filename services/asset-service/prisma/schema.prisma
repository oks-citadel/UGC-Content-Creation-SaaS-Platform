// Prisma schema for CreatorBridge Asset Service
// Manages media storage, transcoding, CDN delivery, and brand asset libraries

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/asset-service-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum AssetType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  ARCHIVE
}

enum AssetStatus {
  UPLOADING
  PROCESSING
  READY
  FAILED
  DELETED
}

enum AssetCategory {
  CONTENT           // UGC content submissions
  BRAND_ASSET       // Brand library assets
  PORTFOLIO         // Creator portfolio items
  CAMPAIGN_BRIEF    // Campaign brief attachments
  PROFILE           // Profile images/avatars
  TEMPLATE          // Template assets
}

enum ProcessingJobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ProcessingJobType {
  TRANSCODE
  THUMBNAIL
  PREVIEW
  MODERATION
  WATERMARK
  OPTIMIZE
}

// ============================================================================
// MODELS
// ============================================================================

model Asset {
  id                String        @id @default(uuid()) @db.Uuid
  organizationId    String?       @map("organization_id") @db.Uuid
  uploadedBy        String        @map("uploaded_by") @db.Uuid

  // File information
  originalFilename  String        @map("original_filename")
  filename          String
  mimeType          String        @map("mime_type")
  fileSize          BigInt        @map("file_size")
  checksum          String?       // SHA-256 hash for deduplication

  // Asset classification
  type              AssetType
  category          AssetCategory
  status            AssetStatus   @default(UPLOADING)

  // Storage locations
  blobUrl           String        @map("blob_url")           // Azure Blob Storage URL
  cdnUrl            String?       @map("cdn_url")            // CDN delivery URL
  thumbnailUrl      String?       @map("thumbnail_url")
  previewUrl        String?       @map("preview_url")        // Animated preview for videos

  // Media metadata
  width             Int?
  height            Int?
  duration          Float?        // Duration in seconds for video/audio
  fps               Float?        // Frames per second for video
  bitrate           Int?          // Bitrate in bps
  codec             String?
  colorSpace        String?       @map("color_space")

  // Content analysis
  blurhash          String?       // Placeholder blur hash
  dominantColors    String[]      @default([]) @map("dominant_colors")

  // AI analysis results
  moderationScore   Float?        @map("moderation_score")
  moderationPassed  Boolean?      @map("moderation_passed")
  moderationLabels  Json?         @map("moderation_labels")
  transcription     String?       @db.Text
  detectedObjects   String[]      @default([]) @map("detected_objects")

  // Organization
  folderId          String?       @map("folder_id") @db.Uuid
  tags              String[]      @default([])
  metadata          Json?

  // Processing
  processingError   String?       @map("processing_error")
  processedAt       DateTime?     @map("processed_at")

  // Timestamps
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  deletedAt         DateTime?     @map("deleted_at")

  // Relations
  variants          AssetVariant[]
  processingJobs    ProcessingJob[]
  folder            AssetFolder?   @relation(fields: [folderId], references: [id])
  usageTracking     AssetUsage[]

  @@index([organizationId])
  @@index([uploadedBy])
  @@index([type])
  @@index([category])
  @@index([status])
  @@index([folderId])
  @@index([createdAt])
  @@index([checksum])
  @@map("assets")
}

model AssetVariant {
  id          String   @id @default(uuid()) @db.Uuid
  assetId     String   @map("asset_id") @db.Uuid

  // Variant info
  name        String   // e.g., "1080p", "720p", "thumbnail", "preview"
  width       Int?
  height      Int?
  fileSize    BigInt   @map("file_size")
  mimeType    String   @map("mime_type")

  // URLs
  blobUrl     String   @map("blob_url")
  cdnUrl      String?  @map("cdn_url")

  // Video specific
  bitrate     Int?
  fps         Float?
  codec       String?

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")

  asset       Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([assetId, name])
  @@index([assetId])
  @@map("asset_variants")
}

model AssetFolder {
  id              String        @id @default(uuid()) @db.Uuid
  organizationId  String        @map("organization_id") @db.Uuid
  parentId        String?       @map("parent_id") @db.Uuid

  name            String
  description     String?
  path            String        // Full path like "/Brand Guidelines/Logos"
  color           String?       // Folder color for UI
  icon            String?       // Custom icon

  // Permissions
  isPublic        Boolean       @default(false) @map("is_public")
  sharedWith      String[]      @default([]) @map("shared_with") // User IDs

  // Stats (denormalized for performance)
  assetCount      Int           @default(0) @map("asset_count")
  totalSize       BigInt        @default(0) @map("total_size")

  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  createdBy       String        @map("created_by") @db.Uuid

  // Relations
  parent          AssetFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id])
  children        AssetFolder[] @relation("FolderHierarchy")
  assets          Asset[]

  @@unique([organizationId, path])
  @@index([organizationId])
  @@index([parentId])
  @@map("asset_folders")
}

model ProcessingJob {
  id              String              @id @default(uuid()) @db.Uuid
  assetId         String              @map("asset_id") @db.Uuid

  type            ProcessingJobType
  status          ProcessingJobStatus @default(QUEUED)
  priority        Int                 @default(0)

  // Job configuration
  config          Json?               // Job-specific parameters

  // Progress tracking
  progress        Int                 @default(0) // 0-100
  currentStep     String?             @map("current_step")

  // Results
  resultUrl       String?             @map("result_url")
  resultMetadata  Json?               @map("result_metadata")

  // Error handling
  error           String?
  errorDetails    Json?               @map("error_details")
  retryCount      Int                 @default(0) @map("retry_count")
  maxRetries      Int                 @default(3) @map("max_retries")

  // Timing
  queuedAt        DateTime            @default(now()) @map("queued_at")
  startedAt       DateTime?           @map("started_at")
  completedAt     DateTime?           @map("completed_at")

  // Worker info
  workerId        String?             @map("worker_id")

  asset           Asset               @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([status])
  @@index([type])
  @@index([queuedAt])
  @@index([priority, queuedAt])
  @@map("processing_jobs")
}

model AssetUsage {
  id              String   @id @default(uuid()) @db.Uuid
  assetId         String   @map("asset_id") @db.Uuid

  // Usage context
  usedIn          String   @map("used_in")       // e.g., "campaign", "content", "gallery"
  referenceId     String   @map("reference_id")  // ID of the campaign/content/gallery
  referenceType   String   @map("reference_type")

  // Usage details
  usedBy          String   @map("used_by") @db.Uuid
  usedAt          DateTime @default(now()) @map("used_at")

  // Tracking
  accessCount     Int      @default(0) @map("access_count")
  lastAccessedAt  DateTime @default(now()) @map("last_accessed_at")

  asset           Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([assetId, referenceId, referenceType])
  @@index([assetId])
  @@index([referenceId])
  @@index([usedBy])
  @@map("asset_usage")
}

model UploadSession {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  organizationId  String?  @map("organization_id") @db.Uuid

  // Upload details
  filename        String
  mimeType        String   @map("mime_type")
  fileSize        BigInt   @map("file_size")
  category        AssetCategory

  // Presigned URL info
  uploadUrl       String   @map("upload_url") @db.Text
  blobName        String   @map("blob_name")

  // Status
  isComplete      Boolean  @default(false) @map("is_complete")
  assetId         String?  @map("asset_id") @db.Uuid // Created asset after upload

  // Metadata to attach after upload
  metadata        Json?
  folderId        String?  @map("folder_id") @db.Uuid
  tags            String[] @default([])

  // Timing
  expiresAt       DateTime @map("expires_at")
  createdAt       DateTime @default(now()) @map("created_at")
  completedAt     DateTime? @map("completed_at")

  @@index([userId])
  @@index([expiresAt])
  @@index([isComplete])
  @@map("upload_sessions")
}

model StorageQuota {
  id              String   @id @default(uuid()) @db.Uuid
  organizationId  String   @unique @map("organization_id") @db.Uuid

  // Quota limits (in bytes)
  totalQuota      BigInt   @map("total_quota")
  usedStorage     BigInt   @default(0) @map("used_storage")

  // Asset counts
  totalAssets     Int      @default(0) @map("total_assets")

  // Warnings
  warningThreshold Float   @default(0.8) @map("warning_threshold") // 80%
  warningNotified Boolean  @default(false) @map("warning_notified")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  lastCalculated  DateTime @default(now()) @map("last_calculated")

  @@map("storage_quotas")
}
