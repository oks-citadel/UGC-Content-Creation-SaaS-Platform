generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/workflow-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Workflow {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  name        String
  description String?
  definition  Json     // n8n-compatible workflow definition
  trigger     TriggerType
  triggerConfig Json?  @map("trigger_config")
  isActive    Boolean  @default(false) @map("is_active")
  version     Int      @default(1)
  tags        String[]
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  executions  WorkflowExecution[]
  schedules   WorkflowSchedule[]
  flowTriggers FlowTrigger[]
  flowActions  FlowAction[]
  simulations  SimulationResult[]

  @@index([userId])
  @@index([isActive])
  @@map("workflows")
}

model WorkflowExecution {
  id          String   @id @default(uuid()) @db.Uuid
  workflowId  String   @map("workflow_id") @db.Uuid
  status      ExecutionStatus
  trigger     String?
  input       Json?
  output      Json?
  error       String?
  stepsExecuted Int    @default(0) @map("steps_executed")
  stepsFailed   Int    @default(0) @map("steps_failed")
  duration    Int?     // milliseconds
  startedAt   DateTime @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")

  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  steps       ExecutionStep[]

  @@index([workflowId])
  @@index([status])
  @@index([startedAt])
  @@map("workflow_executions")
}

model ExecutionStep {
  id          String   @id @default(uuid()) @db.Uuid
  executionId String   @map("execution_id") @db.Uuid
  stepId      String   @map("step_id")
  name        String
  type        String
  status      ExecutionStatus
  input       Json?
  output      Json?
  error       String?
  duration    Int?     // milliseconds
  startedAt   DateTime @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")

  execution   WorkflowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([executionId])
  @@map("execution_steps")
}

model WorkflowSchedule {
  id          String   @id @default(uuid()) @db.Uuid
  workflowId  String   @map("workflow_id") @db.Uuid
  cronExpression String @map("cron_expression")
  timezone    String   @default("UTC")
  isActive    Boolean  @default(true) @map("is_active")
  lastRunAt   DateTime? @map("last_run_at")
  nextRunAt   DateTime? @map("next_run_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([nextRunAt])
  @@map("workflow_schedules")
}

enum TriggerType {
  MANUAL
  SCHEDULE
  WEBHOOK
  EVENT
  EMAIL
  DATABASE
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  TIMEOUT
}

// Flow Trigger Model - Unified trigger system
model FlowTrigger {
  id          String           @id @default(uuid()) @db.Uuid
  workflowId  String?          @map("workflow_id") @db.Uuid
  userId      String           @map("user_id") @db.Uuid
  name        String
  description String?
  type        FlowTriggerType
  config      Json
  conditions  Json?
  isActive    Boolean          @default(true) @map("is_active")
  metadata    Json?
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  workflow Workflow? @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([userId])
  @@index([type])
  @@index([isActive])
  @@map("flow_triggers")
}

// Flow Action Model - Unified action system
model FlowAction {
  id          String         @id @default(uuid()) @db.Uuid
  workflowId  String?        @map("workflow_id") @db.Uuid
  userId      String         @map("user_id") @db.Uuid
  name        String
  description String?
  type        FlowActionType
  config      Json
  order       Int            @default(0)
  retryConfig Json?          @map("retry_config")
  timeout     Int?           // milliseconds
  isActive    Boolean        @default(true) @map("is_active")
  metadata    Json?
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  workflow Workflow? @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([userId])
  @@index([type])
  @@index([isActive])
  @@map("flow_actions")
}

// Simulation Result Model
model SimulationResult {
  id             String          @id @default(uuid()) @db.Uuid
  workflowId     String          @map("workflow_id") @db.Uuid
  simulationType SimulationType
  status         ExecutionStatus
  testData       Json?           @map("test_data")
  input          Json?
  output         Json?
  steps          Json?
  errors         Json?
  warnings       Json?
  metrics        Json?
  duration       Int?
  startedAt      DateTime        @default(now()) @map("started_at")
  completedAt    DateTime?       @map("completed_at")
  createdBy      String?         @map("created_by") @db.Uuid

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([status])
  @@index([startedAt])
  @@map("simulation_results")
}

enum FlowTriggerType {
  EVENT           // event-based trigger
  SCHEDULE        // cron/schedule-based
  WEBHOOK         // incoming webhook
  CONDITION       // condition-based
  SEGMENT_ENTRY   // user enters segment
  SEGMENT_EXIT    // user exits segment
  API_CALL        // explicit API trigger
}

enum FlowActionType {
  SEND_EMAIL
  SEND_SMS
  SEND_NOTIFICATION
  SEND_PUSH
  UPDATE_SEGMENT
  UPDATE_PROFILE
  CALL_WEBHOOK
  CALL_API
  DELAY
  CONDITION
  SPLIT
  MERGE
  TRANSFORM
  LOG
}

enum SimulationType {
  DRY_RUN
  FULL_SIMULATION
  STEP_BY_STEP
}
