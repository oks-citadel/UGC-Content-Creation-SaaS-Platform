generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/analytics-service-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model MetricSnapshot {
  id          String   @id @default(uuid())
  entityType  String   @map("entity_type") // content, campaign, creator, commerce
  entityId    String   @map("entity_id")
  metrics     Json     // flexible metrics storage
  period      String   // hourly, daily, weekly, monthly
  recordedAt  DateTime @map("recorded_at") @default(now())
  createdAt   DateTime @map("created_at") @default(now())
  updatedAt   DateTime @map("updated_at") @updatedAt

  @@index([entityType, entityId, recordedAt])
  @@index([period, recordedAt])
  @@map("metric_snapshots")
}

model Dashboard {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")
  brandId     String?  @map("brand_id")
  name        String
  description String?
  widgets     Json     // widget configurations
  layout      Json     // grid layout configuration
  isDefault   Boolean  @default(false) @map("is_default")
  isPublic    Boolean  @default(false) @map("is_public")
  settings    Json?    // theme, refresh rate, etc.
  createdAt   DateTime @map("created_at") @default(now())
  updatedAt   DateTime @map("updated_at") @updatedAt

  @@index([userId])
  @@index([brandId])
  @@map("dashboards")
}

model Report {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  brandId     String?  @map("brand_id")
  name        String
  description String?
  type        String   // performance, comparison, trend, custom
  filters     Json     // date range, entities, metrics
  schedule    Json?    // cron expression, timezone
  format      String   @default("pdf") // pdf, excel, csv
  recipients  Json?    // email addresses
  template    String?  // whitelabel template ID
  isActive    Boolean  @default(true) @map("is_active")
  lastRunAt   DateTime? @map("last_run_at")
  createdAt   DateTime @map("created_at") @default(now())
  updatedAt   DateTime @map("updated_at") @updatedAt

  executions ReportExecution[]

  @@index([userId])
  @@index([brandId])
  @@index([isActive, schedule])
  @@map("reports")
}

model ReportExecution {
  id          String   @id @default(uuid())
  reportId    String   @map("report_id")
  status      String   // pending, processing, completed, failed
  fileUrl     String?  @map("file_url")
  fileSize    Int?     @map("file_size")
  error       String?
  metadata    Json?    // execution details
  startedAt   DateTime @map("started_at") @default(now())
  completedAt DateTime? @map("completed_at")

  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([status, startedAt])
  @@map("report_executions")
}

model Alert {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  brandId     String?  @map("brand_id")
  name        String
  metric      String   // metric to monitor
  entityType  String   @map("entity_type")
  entityId    String?  @map("entity_id") // null for global alerts
  condition   String   // greater_than, less_than, equals, change_percent
  threshold   Float
  channels    Json     // email, slack, webhook, sms
  isActive    Boolean  @default(true) @map("is_active")
  cooldown    Int      @default(3600) // seconds before re-alerting
  lastTriggered DateTime? @map("last_triggered")
  createdAt   DateTime @map("created_at") @default(now())
  updatedAt   DateTime @map("updated_at") @updatedAt

  triggers AlertTrigger[]

  @@index([userId])
  @@index([brandId])
  @@index([isActive, entityType])
  @@map("alerts")
}

model AlertTrigger {
  id          String   @id @default(uuid())
  alertId     String   @map("alert_id")
  value       Float    // actual value that triggered alert
  threshold   Float    // threshold at time of trigger
  metadata    Json?    // additional context
  notified    Boolean  @default(false)
  triggeredAt DateTime @map("triggered_at") @default(now())

  alert Alert @relation(fields: [alertId], references: [id], onDelete: Cascade)

  @@index([alertId])
  @@index([triggeredAt])
  @@map("alert_triggers")
}

model AnomalyDetection {
  id          String   @id @default(uuid())
  metric      String
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id")
  baseline    Float    // expected value
  actual      Float    // actual value
  deviation   Float    // standard deviations from baseline
  severity    String   // low, medium, high, critical
  metadata    Json?    // statistical details
  resolved    Boolean  @default(false)
  resolvedAt  DateTime? @map("resolved_at")
  detectedAt  DateTime @map("detected_at") @default(now())

  @@index([entityType, entityId])
  @@index([severity, resolved])
  @@index([detectedAt])
  @@map("anomaly_detections")
}

model CreativeFatigue {
  id              String   @id @default(uuid())
  contentId       String   @map("content_id")
  platformId      String   @map("platform_id")
  fatigueScore    Float    @map("fatigue_score") // 0-100
  performanceTrend String  @map("performance_trend") // declining, stable, improving
  recommendation  String?  // refresh, retire, boost
  metrics         Json     // historical performance data
  threshold       Float    @default(70.0) // score threshold for action
  actionTaken     String?  @map("action_taken")
  detectedAt      DateTime @map("detected_at") @default(now())
  updatedAt       DateTime @map("updated_at") @updatedAt

  @@index([contentId])
  @@index([fatigueScore])
  @@index([detectedAt])
  @@map("creative_fatigues")
}

model CachedMetric {
  id          String   @id @default(uuid())
  cacheKey    String   @unique @map("cache_key")
  data        Json
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @map("created_at") @default(now())

  @@index([cacheKey, expiresAt])
  @@map("cached_metrics")
}

// ============================================
// Attribution System Models
// ============================================

model Touchpoint {
  id          String   @id @default(uuid())
  visitorId   String   @map("visitor_id")
  sessionId   String?  @map("session_id")
  channel     String   // organic, paid_search, social, email, referral, direct
  source      String?  // google, facebook, twitter, newsletter
  medium      String?  // cpc, organic, email, social
  campaign    String?  // campaign identifier
  content     String?  // ad content or creative ID
  term        String?  // search term (for paid search)
  landingPage String?  @map("landing_page")
  referrer    String?
  deviceType  String?  @map("device_type") // desktop, mobile, tablet
  browser     String?
  country     String?
  region      String?
  city        String?
  metadata    Json?
  timestamp   DateTime @default(now())
  createdAt   DateTime @map("created_at") @default(now())

  attributedConversions ConversionTouchpoint[]

  @@index([visitorId, timestamp])
  @@index([channel, timestamp])
  @@index([campaign, timestamp])
  @@index([source, medium])
  @@map("touchpoints")
}

model Conversion {
  id              String   @id @default(uuid())
  visitorId       String   @map("visitor_id")
  conversionType  String   @map("conversion_type") // purchase, signup, lead, subscription
  value           Float    @default(0)
  currency        String   @default("USD")
  orderId         String?  @map("order_id")
  productId       String?  @map("product_id")
  metadata        Json?
  timestamp       DateTime @default(now())
  createdAt       DateTime @map("created_at") @default(now())

  touchpoints        ConversionTouchpoint[]
  attributionResults AttributionResult[]

  @@index([visitorId, timestamp])
  @@index([conversionType, timestamp])
  @@index([timestamp])
  @@map("conversions")
}

model ConversionTouchpoint {
  id            String   @id @default(uuid())
  conversionId  String   @map("conversion_id")
  touchpointId  String   @map("touchpoint_id")
  position      Int      // order in the customer journey (1 = first)
  createdAt     DateTime @map("created_at") @default(now())

  conversion Conversion @relation(fields: [conversionId], references: [id], onDelete: Cascade)
  touchpoint Touchpoint @relation(fields: [touchpointId], references: [id], onDelete: Cascade)

  @@unique([conversionId, touchpointId])
  @@index([conversionId])
  @@index([touchpointId])
  @@map("conversion_touchpoints")
}

model AttributionResult {
  id               String   @id @default(uuid())
  conversionId     String   @map("conversion_id")
  model            String   // first_touch, last_touch, linear, time_decay, position_based
  channel          String
  source           String?
  medium           String?
  campaign         String?
  touchpointId     String?  @map("touchpoint_id")
  attributedValue  Float    @map("attributed_value")
  attributedPct    Float    @map("attributed_pct") // percentage 0-100
  position         Int?
  totalTouchpoints Int      @map("total_touchpoints")
  metadata         Json?
  calculatedAt     DateTime @map("calculated_at") @default(now())

  conversion Conversion @relation(fields: [conversionId], references: [id], onDelete: Cascade)

  @@index([conversionId, model])
  @@index([channel, model, calculatedAt])
  @@index([campaign, model, calculatedAt])
  @@index([calculatedAt])
  @@map("attribution_results")
}
