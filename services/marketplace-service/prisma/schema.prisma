// Marketplace Service - Prisma Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Campaign Opportunities
model Opportunity {
  id            String   @id @default(cuid())
  campaignId    String   @map("campaign_id")
  brandId       String   @map("brand_id")

  title         String
  description   String   @db.Text
  requirements  Json     // Array of requirement objects

  budget        Decimal  @db.Decimal(12, 2)
  currency      String   @default("USD") @db.VarChar(3)

  deadline      DateTime
  status        OpportunityStatus @default(OPEN)

  // Targeting
  targetNiche   String[] @map("target_niche")
  minFollowers  Int?     @map("min_followers")
  maxFollowers  Int?     @map("max_followers")
  locations     String[] // Country codes

  // Deliverables
  deliverables  Json     // Array of deliverable objects

  // Metadata
  slots         Int      @default(1) // Number of creators needed
  filledSlots   Int      @default(0) @map("filled_slots")

  viewCount     Int      @default(0) @map("view_count")
  bidCount      Int      @default(0) @map("bid_count")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  closedAt      DateTime? @map("closed_at")

  // Relations
  bids          Bid[]
  contracts     Contract[]

  @@index([status, deadline])
  @@index([campaignId])
  @@index([brandId])
  @@index([createdAt])
  @@map("opportunities")
}

enum OpportunityStatus {
  DRAFT
  OPEN
  IN_PROGRESS
  FILLED
  CLOSED
  CANCELLED
}

// Creator Bids
model Bid {
  id              String   @id @default(cuid())
  opportunityId   String   @map("opportunity_id")
  creatorId       String   @map("creator_id")

  proposedRate    Decimal  @db.Decimal(12, 2) @map("proposed_rate")
  currency        String   @default("USD") @db.VarChar(3)

  pitch           String   @db.Text
  portfolioItems  Json     @map("portfolio_items") // Array of portfolio URLs

  estimatedDays   Int?     @map("estimated_days")
  additionalNotes String?  @db.Text @map("additional_notes")

  status          BidStatus @default(PENDING)

  // Negotiation
  counterOffer    Decimal? @db.Decimal(12, 2) @map("counter_offer")
  counterOfferBy  String?  @map("counter_offer_by") // creatorId or brandId

  rejectionReason String?  @db.Text @map("rejection_reason")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  respondedAt     DateTime? @map("responded_at")

  // Relations
  opportunity     Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@unique([opportunityId, creatorId])
  @@index([creatorId, status])
  @@index([opportunityId, status])
  @@map("bids")
}

enum BidStatus {
  PENDING
  UNDER_REVIEW
  SHORTLISTED
  ACCEPTED
  REJECTED
  WITHDRAWN
  COUNTERED
}

// Contracts
model Contract {
  id              String   @id @default(cuid())
  contractNumber  String   @unique @map("contract_number") // Human-readable ID

  opportunityId   String   @map("opportunity_id")
  creatorId       String   @map("creator_id")
  brandId         String   @map("brand_id")

  // Terms
  terms           Json     // Contract terms and conditions
  paymentTerms    Json     @map("payment_terms") // Payment schedule, milestones

  totalAmount     Decimal  @db.Decimal(12, 2) @map("total_amount")
  currency        String   @default("USD") @db.VarChar(3)

  // Deliverables & Timeline
  deliverables    Json     // Expected deliverables
  startDate       DateTime @map("start_date")
  endDate         DateTime @map("end_date")

  // Status & Signatures
  status          ContractStatus @default(DRAFT)

  // E-signature tracking
  creatorSigned   Boolean  @default(false) @map("creator_signed")
  creatorSignedAt DateTime? @map("creator_signed_at")
  brandSigned     Boolean  @default(false) @map("brand_signed")
  brandSignedAt   DateTime? @map("brand_signed_at")

  // DocuSign integration
  docusignEnvelopeId String? @map("docusign_envelope_id")
  documentUrl        String? @map("document_url")
  signedDocumentUrl  String? @map("signed_document_url")

  // Metadata
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  signedAt        DateTime? @map("signed_at")
  terminatedAt    DateTime? @map("terminated_at")
  terminationReason String? @db.Text @map("termination_reason")

  // Relations
  opportunity     Opportunity @relation(fields: [opportunityId], references: [id])
  payouts         Payout[]
  disputes        Dispute[]

  @@index([creatorId, status])
  @@index([brandId, status])
  @@index([opportunityId])
  @@map("contracts")
}

enum ContractStatus {
  DRAFT
  PENDING_SIGNATURES
  ACTIVE
  COMPLETED
  TERMINATED
  DISPUTED
}

// Payouts
model Payout {
  id              String   @id @default(cuid())
  contractId      String?  @map("contract_id") // Optional: can be standalone
  creatorId       String   @map("creator_id")

  amount          Decimal  @db.Decimal(12, 2)
  currency        String   @default("USD") @db.VarChar(3)

  // Fees
  platformFee     Decimal  @db.Decimal(12, 2) @map("platform_fee")
  processingFee   Decimal  @db.Decimal(12, 2) @map("processing_fee")
  netAmount       Decimal  @db.Decimal(12, 2) @map("net_amount")

  status          PayoutStatus @default(PENDING)
  method          PayoutMethod? @map("payout_method")

  // Processing details
  provider        String?  // stripe, paystack, flutterwave
  transactionId   String?  @unique @map("transaction_id")

  // Metadata
  description     String?
  metadata        Json?    // Additional data

  requestedAt     DateTime @default(now()) @map("requested_at")
  processedAt     DateTime? @map("processed_at")
  failedAt        DateTime? @map("failed_at")
  failureReason   String?  @db.Text @map("failure_reason")

  // Relations
  contract        Contract? @relation(fields: [contractId], references: [id])

  @@index([creatorId, status])
  @@index([contractId])
  @@index([requestedAt])
  @@map("payouts")
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PayoutMethod {
  BANK_TRANSFER
  PAYPAL
  STRIPE_CONNECT
  PAYSTACK
  FLUTTERWAVE
  MOBILE_MONEY
}

// Creator Payout Methods
model PayoutMethodConfig {
  id          String   @id @default(cuid())
  creatorId   String   @map("creator_id")

  type        PayoutMethod

  // Account details (encrypted)
  details     Json     // Bank account, PayPal email, etc.

  isDefault   Boolean  @default(false) @map("is_default")
  isVerified  Boolean  @default(false) @map("is_verified")

  // Provider-specific IDs
  stripeAccountId    String? @map("stripe_account_id")
  paystackRecipient  String? @map("paystack_recipient")
  flutterwaveBeneficiary String? @map("flutterwave_beneficiary")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([creatorId, type, isDefault])
  @@index([creatorId])
  @@map("payout_method_configs")
}

// Disputes
model Dispute {
  id              String   @id @default(cuid())
  contractId      String   @map("contract_id")

  raisedBy        String   @map("raised_by") // creatorId or brandId
  raisedByRole    Role     @map("raised_by_role")

  reason          String   @db.Text
  description     String   @db.Text
  evidence        Json?    // URLs to supporting documents

  status          DisputeStatus @default(OPEN)
  priority        Priority @default(MEDIUM)

  // Resolution
  assignedTo      String?  @map("assigned_to") // Admin/mediator ID
  resolution      String?  @db.Text
  resolvedBy      String?  @map("resolved_by")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  resolvedAt      DateTime? @map("resolved_at")

  // Relations
  contract        Contract @relation(fields: [contractId], references: [id])
  messages        DisputeMessage[]

  @@index([contractId, status])
  @@index([raisedBy])
  @@map("disputes")
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  AWAITING_RESPONSE
  ESCALATED
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum Role {
  CREATOR
  BRAND
  ADMIN
}

// Dispute Messages
model DisputeMessage {
  id          String   @id @default(cuid())
  disputeId   String   @map("dispute_id")

  senderId    String   @map("sender_id")
  senderRole  Role     @map("sender_role")

  message     String   @db.Text
  attachments Json?    // URLs to files

  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  dispute     Dispute  @relation(fields: [disputeId], references: [id], onDelete: Cascade)

  @@index([disputeId])
  @@map("dispute_messages")
}

// Ambassador Programs
model AmbassadorProgram {
  id              String   @id @default(cuid())
  brandId         String   @map("brand_id")

  name            String
  description     String   @db.Text

  // Program structure
  tiers           Json     // Array of tier configurations
  benefits        Json     // Perks, commission rates, etc.
  requirements    Json     // Minimum performance metrics

  // Terms
  commissionRate  Decimal? @db.Decimal(5, 2) @map("commission_rate")
  paymentSchedule String?  @map("payment_schedule") // monthly, quarterly

  isActive        Boolean  @default(true) @map("is_active")
  isPublic        Boolean  @default(false) @map("is_public") // Visible to all creators

  maxAmbassadors  Int?     @map("max_ambassadors")
  currentCount    Int      @default(0) @map("current_count")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  ambassadors     Ambassador[]

  @@index([brandId, isActive])
  @@map("ambassador_programs")
}

// Brand Ambassadors
model Ambassador {
  id              String   @id @default(cuid())
  programId       String   @map("program_id")
  creatorId       String   @map("creator_id")

  tier            String   // bronze, silver, gold, platinum, etc.
  status          AmbassadorStatus @default(INVITED)

  // Performance tracking
  performanceMetrics Json  @default("{}") @map("performance_metrics")
  totalEarnings      Decimal @default(0) @db.Decimal(12, 2) @map("total_earnings")

  // Dates
  invitedAt       DateTime @default(now()) @map("invited_at")
  joinedAt        DateTime? @map("joined_at")
  lastActiveAt    DateTime? @map("last_active_at")
  terminatedAt    DateTime? @map("terminated_at")

  // Relations
  program         AmbassadorProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([programId, creatorId])
  @@index([creatorId, status])
  @@index([programId, tier])
  @@map("ambassadors")
}

enum AmbassadorStatus {
  INVITED
  ACTIVE
  PAUSED
  TERMINATED
  DECLINED
}

// Currency Exchange Rates (for multi-currency support)
model ExchangeRate {
  id            String   @id @default(cuid())

  baseCurrency  String   @map("base_currency") @db.VarChar(3)
  targetCurrency String  @map("target_currency") @db.VarChar(3)

  rate          Decimal  @db.Decimal(18, 6)

  createdAt     DateTime @default(now()) @map("created_at")
  validUntil    DateTime @map("valid_until")

  @@unique([baseCurrency, targetCurrency, createdAt])
  @@index([baseCurrency, targetCurrency])
  @@map("exchange_rates")
}
