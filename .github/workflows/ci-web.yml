# =============================================================================
# Web Applications CI Pipeline
# =============================================================================

name: Web CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/web/**'
      - 'apps/creator-portal/**'
      - 'apps/brand-portal/**'
      - 'apps/admin/**'
      - 'packages/ui/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/web/**'
      - 'apps/creator-portal/**'
      - 'apps/brand-portal/**'
      - 'apps/admin/**'
      - 'packages/ui/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.filter.outputs.web }}
      creator-portal: ${{ steps.filter.outputs.creator-portal }}
      brand-portal: ${{ steps.filter.outputs.brand-portal }}
      admin: ${{ steps.filter.outputs.admin }}
      ui: ${{ steps.filter.outputs.ui }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            web:
              - 'apps/web/**'
            creator-portal:
              - 'apps/creator-portal/**'
            brand-portal:
              - 'apps/brand-portal/**'
            admin:
              - 'apps/admin/**'
            ui:
              - 'packages/ui/**'

  build-ui:
    name: Build UI Package
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.ui == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build UI package
        run: pnpm turbo run build --filter='@nexus/ui'

      - name: Type check
        run: pnpm turbo run type-check --filter='@nexus/ui'

      - name: Lint
        run: pnpm turbo run lint --filter='@nexus/ui'

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ui-dist
          path: packages/ui/dist
          retention-days: 1

  build-web-app:
    name: Build Web App
    runs-on: ubuntu-latest
    needs: [detect-changes, build-ui]
    if: always() && (needs.detect-changes.outputs.web == 'true' || needs.detect-changes.outputs.ui == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Download UI package
        uses: actions/download-artifact@v4
        with:
          name: ui-dist
          path: packages/ui/dist
        continue-on-error: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build dependencies
        run: pnpm turbo run build --filter='@nexus/types' --filter='@nexus/utils' --filter='@nexus/ui'

      - name: Type check
        run: pnpm turbo run type-check --filter='./apps/web'

      - name: Lint
        run: pnpm turbo run lint --filter='./apps/web'

      - name: Build
        run: pnpm turbo run build --filter='./apps/web'
        env:
          NEXT_PUBLIC_API_URL: https://api.nexusugc.com

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: apps/web/.next
          retention-days: 7

  build-creator-portal:
    name: Build Creator Portal
    runs-on: ubuntu-latest
    needs: [detect-changes, build-ui]
    if: always() && (needs.detect-changes.outputs.creator-portal == 'true' || needs.detect-changes.outputs.ui == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Download UI package
        uses: actions/download-artifact@v4
        with:
          name: ui-dist
          path: packages/ui/dist
        continue-on-error: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build dependencies
        run: pnpm turbo run build --filter='@nexus/types' --filter='@nexus/utils' --filter='@nexus/ui'

      - name: Type check
        run: pnpm turbo run type-check --filter='./apps/creator-portal'

      - name: Lint
        run: pnpm turbo run lint --filter='./apps/creator-portal'

      - name: Build
        run: pnpm turbo run build --filter='./apps/creator-portal'
        env:
          NEXT_PUBLIC_API_URL: https://api.nexusugc.com

  build-brand-portal:
    name: Build Brand Portal
    runs-on: ubuntu-latest
    needs: [detect-changes, build-ui]
    if: always() && (needs.detect-changes.outputs.brand-portal == 'true' || needs.detect-changes.outputs.ui == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Download UI package
        uses: actions/download-artifact@v4
        with:
          name: ui-dist
          path: packages/ui/dist
        continue-on-error: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build dependencies
        run: pnpm turbo run build --filter='@nexus/types' --filter='@nexus/utils' --filter='@nexus/ui'

      - name: Type check
        run: pnpm turbo run type-check --filter='./apps/brand-portal'

      - name: Lint
        run: pnpm turbo run lint --filter='./apps/brand-portal'

      - name: Build
        run: pnpm turbo run build --filter='./apps/brand-portal'
        env:
          NEXT_PUBLIC_API_URL: https://api.nexusugc.com

  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    needs: build-web-app
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: apps/web/.next

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Lighthouse
        run: npm install -g @lhci/cli

      - name: Run Lighthouse
        run: |
          cd apps/web
          npm start &
          sleep 10
          lhci autorun
        env:
          LHCI_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  summary:
    name: Web CI Summary
    runs-on: ubuntu-latest
    needs: [build-ui, build-web-app, build-creator-portal, build-brand-portal]
    if: always()
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.build-web-app.result }}" == "failure" ]] || \
             [[ "${{ needs.build-creator-portal.result }}" == "failure" ]] || \
             [[ "${{ needs.build-brand-portal.result }}" == "failure" ]]; then
            echo "Web CI failed"
            exit 1
          fi
          echo "Web CI passed"
