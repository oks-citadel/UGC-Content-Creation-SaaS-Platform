name: Deploy to Railway

on:
  push:
    branches: [main, develop]
    paths:
      - 'services/**'
      - 'workers/**'
      - 'packages/**'
      - 'database/**'
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        default: 'api-gateway'
        type: choice
        options:
          - all
          - api-gateway
          - auth-service
          - user-service
          - campaign-service
          - content-service
          - creator-service
          - commerce-service
          - billing-service
          - marketplace-service
          - notification-service
          - analytics-service
          - asset-service
          - workflow-service
          - integration-service
          - compliance-service
          - payout-service
          - rights-service
          - worker-video-processor
          - worker-social-publisher
          - worker-analytics-aggregator
          - worker-notification-dispatcher
      environment:
        description: 'Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  # =============================================================================
  # Detect Changes
  # =============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changes.outputs.services }}
      workers: ${{ steps.changes.outputs.workers }}
      packages: ${{ steps.changes.outputs.packages }}
      database: ${{ steps.changes.outputs.database }}
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            services:
              - 'services/**'
            workers:
              - 'workers/**'
            packages:
              - 'packages/**'
            database:
              - 'database/**'

      - name: Build deployment matrix
        id: matrix
        run: |
          if [[ "${{ github.event.inputs.service }}" == "all" ]] || [[ "${{ steps.changes.outputs.services }}" == "true" ]]; then
            echo 'matrix={"service":["api-gateway","auth-service","user-service","campaign-service","content-service","creator-service","notification-service","analytics-service"]}' >> $GITHUB_OUTPUT
          elif [[ -n "${{ github.event.inputs.service }}" ]]; then
            echo 'matrix={"service":["${{ github.event.inputs.service }}"]}' >> $GITHUB_OUTPUT
          else
            echo 'matrix={"service":[]}' >> $GITHUB_OUTPUT
          fi

  # =============================================================================
  # Database Migrations
  # =============================================================================
  migrate-database:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.database == 'true' || github.event.inputs.service == 'all'
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Run Prisma migrations
        run: |
          railway run --service auth-service npx prisma migrate deploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # =============================================================================
  # Deploy Services
  # =============================================================================
  deploy-services:
    name: Deploy ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [detect-changes, migrate-database]
    if: always() && (needs.detect-changes.outputs.services == 'true' || github.event.inputs.service != '')
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy ${{ matrix.service }}
        run: |
          cd services/${{ matrix.service }}
          railway up --service ${{ matrix.service }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Verify Health Check
        run: |
          sleep 30
          railway run --service ${{ matrix.service }} curl -sf http://localhost:${PORT:-4000}/health || echo "Health check pending..."
        continue-on-error: true

  # =============================================================================
  # Deploy Workers
  # =============================================================================
  deploy-workers:
    name: Deploy Workers
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-services]
    if: always() && needs.detect-changes.outputs.workers == 'true'
    strategy:
      fail-fast: false
      matrix:
        worker:
          - video-processor
          - social-publisher
          - analytics-aggregator
          - notification-dispatcher
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy ${{ matrix.worker }}
        run: |
          cd workers/${{ matrix.worker }}
          railway up --service worker-${{ matrix.worker }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # =============================================================================
  # Post-Deployment Verification
  # =============================================================================
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-services, deploy-workers]
    if: always()
    steps:
      - name: Check API Gateway Health
        run: |
          # Wait for services to stabilize
          sleep 60

          # Check health endpoints
          echo "Checking API Gateway health..."
          # This would use the actual Railway public URL
          # curl -sf https://${{ secrets.RAILWAY_API_URL }}/health || exit 1

          echo "Deployment verification complete"

      - name: Generate Summary
        run: |
          echo "## Railway Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Database Migration | ${{ needs.migrate-database.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Services | ${{ needs.deploy-services.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workers | ${{ needs.deploy-workers.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Rollback on Failure
  # =============================================================================
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy-services, verify-deployment]
    if: failure() && github.ref == 'refs/heads/main'
    steps:
      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Trigger Rollback
        run: |
          echo "::warning::Deployment failed - manual rollback may be required"
          echo "Run: railway rollback --service <service-name>"
          # Automated rollback would go here
          # railway rollback --service api-gateway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Notify Team
        run: |
          echo "::error::Production deployment failed. Please investigate immediately."
          # Add Slack/Discord notification here
