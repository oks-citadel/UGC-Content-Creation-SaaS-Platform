# =============================================================================
# NEXUS Platform - Identity & Security Audit Workflow
# Scheduled checks for identity configuration and security compliance
# =============================================================================

name: Identity & Security Audit

on:
  # Run daily at 6 AM UTC
  schedule:
    - cron: '0 6 * * *'

  # Manual trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to audit'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

  # Run on identity-related changes
  push:
    paths:
      - 'infrastructure/terraform/modules/identity/**'
      - 'packages/auth/**'
      - 'services/auth-service/**'
      - '.github/workflows/identity-audit.yml'

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

jobs:
  # ===========================================================================
  # Security Group Audit
  # ===========================================================================
  audit-security-groups:
    name: Audit Security Groups
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Check Security Groups Exist
        id: check-groups
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"
          PLATFORM_NAME="nexus"

          echo "## Security Group Audit - ${ENVIRONMENT}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FAILED=0

          # Check subscription tier groups
          for TIER in free starter growth pro business enterprise; do
            GROUP_NAME="${PLATFORM_NAME}-${TIER}-${ENVIRONMENT}"
            COUNT=$(az ad group list --display-name "$GROUP_NAME" --query "length(@)" -o tsv 2>/dev/null || echo "0")

            if [[ "$COUNT" -gt 0 ]]; then
              echo "- :white_check_mark: Group exists: \`$GROUP_NAME\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "- :x: Group missing: \`$GROUP_NAME\`" >> $GITHUB_STEP_SUMMARY
              FAILED=1
            fi
          done

          # Check special groups
          for GROUP in verified support admin suspended; do
            GROUP_NAME="${PLATFORM_NAME}-${GROUP}-${ENVIRONMENT}"
            COUNT=$(az ad group list --display-name "$GROUP_NAME" --query "length(@)" -o tsv 2>/dev/null || echo "0")

            if [[ "$COUNT" -gt 0 ]]; then
              echo "- :white_check_mark: Group exists: \`$GROUP_NAME\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "- :x: Group missing: \`$GROUP_NAME\`" >> $GITHUB_STEP_SUMMARY
              FAILED=1
            fi
          done

          echo "FAILED=$FAILED" >> $GITHUB_OUTPUT

      - name: Check Admin Group Membership
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"
          PLATFORM_NAME="nexus"
          ADMIN_GROUP="${PLATFORM_NAME}-admin-${ENVIRONMENT}"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Admin Group Membership" >> $GITHUB_STEP_SUMMARY

          # Get admin group members
          MEMBERS=$(az ad group member list --group "$ADMIN_GROUP" --query "[].{displayName:displayName, userPrincipalName:userPrincipalName}" -o table 2>/dev/null || echo "No members or group not found")

          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$MEMBERS" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          # Count members
          MEMBER_COUNT=$(az ad group member list --group "$ADMIN_GROUP" --query "length(@)" -o tsv 2>/dev/null || echo "0")
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Total admin members: $MEMBER_COUNT" >> $GITHUB_STEP_SUMMARY

      - name: Check Suspended Users
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"
          PLATFORM_NAME="nexus"
          SUSPENDED_GROUP="${PLATFORM_NAME}-suspended-${ENVIRONMENT}"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Suspended Users" >> $GITHUB_STEP_SUMMARY

          SUSPENDED_COUNT=$(az ad group member list --group "$SUSPENDED_GROUP" --query "length(@)" -o tsv 2>/dev/null || echo "0")

          if [[ "$SUSPENDED_COUNT" -gt 0 ]]; then
            echo ":warning: **$SUSPENDED_COUNT users are currently suspended**" >> $GITHUB_STEP_SUMMARY

            # List suspended users
            SUSPENDED=$(az ad group member list --group "$SUSPENDED_GROUP" --query "[].{displayName:displayName, id:id}" -o table 2>/dev/null)
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$SUSPENDED" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo ":white_check_mark: No suspended users" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if groups missing
        if: steps.check-groups.outputs.FAILED == '1'
        run: |
          echo "::error::One or more security groups are missing"
          exit 1

  # ===========================================================================
  # App Registration Audit
  # ===========================================================================
  audit-app-registrations:
    name: Audit App Registrations
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Check App Registrations
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"
          PLATFORM_NAME="nexus"

          echo "## App Registration Audit - ${ENVIRONMENT}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for APP in web api automation; do
            APP_NAME="${PLATFORM_NAME}-${APP}-${ENVIRONMENT}"
            APP_INFO=$(az ad app list --display-name "$APP_NAME" --query "[0].{appId:appId, displayName:displayName}" -o json 2>/dev/null || echo "{}")

            if [[ "$APP_INFO" != "{}" ]] && [[ "$APP_INFO" != "null" ]]; then
              APP_ID=$(echo "$APP_INFO" | jq -r '.appId // "N/A"')
              echo "- :white_check_mark: \`$APP_NAME\` (Client ID: \`$APP_ID\`)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- :x: \`$APP_NAME\` - NOT FOUND" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Check Credential Expiration
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"
          PLATFORM_NAME="nexus"
          AUTOMATION_APP="${PLATFORM_NAME}-automation-${ENVIRONMENT}"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Credential Expiration Check" >> $GITHUB_STEP_SUMMARY

          # Get app object ID
          APP_OBJECT_ID=$(az ad app list --display-name "$AUTOMATION_APP" --query "[0].id" -o tsv 2>/dev/null || echo "")

          if [[ -n "$APP_OBJECT_ID" ]]; then
            # Get password credentials
            CREDS=$(az ad app credential list --id "$APP_OBJECT_ID" --query "[].{keyId:keyId, endDateTime:endDateTime, displayName:displayName}" -o json 2>/dev/null || echo "[]")

            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            echo "$CREDS" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

            # Check for expiring credentials (within 30 days)
            EXPIRING=$(echo "$CREDS" | jq -r --arg cutoff "$(date -d '+30 days' -Iseconds)" '[.[] | select(.endDateTime < $cutoff)] | length')

            if [[ "$EXPIRING" -gt 0 ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo ":warning: **$EXPIRING credential(s) expiring within 30 days**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo ":warning: Automation app not found" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Self-Healing Validation
  # ===========================================================================
  self-healing-validation:
    name: Self-Healing Validation
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    needs: [audit-security-groups, audit-app-registrations]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS Credentials
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"
          CLUSTER_NAME="aks-marketing-${ENVIRONMENT}"
          RESOURCE_GROUP="marketing-${ENVIRONMENT}-rg"

          az aks get-credentials \
            --resource-group "$RESOURCE_GROUP" \
            --name "$CLUSTER_NAME" \
            --overwrite-existing || echo "Could not get AKS credentials"

      - name: Run Self-Healing Checks
        run: |
          chmod +x ./scripts/self-healing-checks.sh

          ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"

          ./scripts/self-healing-checks.sh \
            --environment "$ENVIRONMENT" \
            --domain "${DOMAIN:-}" \
            --b2c-tenant "${B2C_TENANT:-}" \
            --api-endpoint "${API_ENDPOINT:-}" || true
        env:
          DOMAIN: ${{ vars.DOMAIN }}
          B2C_TENANT: ${{ vars.B2C_TENANT }}
          API_ENDPOINT: ${{ vars.API_ENDPOINT }}

  # ===========================================================================
  # Authorization Middleware Tests
  # ===========================================================================
  test-authorization:
    name: Test Authorization Middleware
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Authorization Tests
        run: |
          pnpm --filter @nexus/auth test || echo "No tests configured yet"

      - name: Type Check Auth Package
        run: |
          pnpm --filter @nexus/auth typecheck || echo "No typecheck configured yet"

  # ===========================================================================
  # Security Scan
  # ===========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  # ===========================================================================
  # Notification
  # ===========================================================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [audit-security-groups, audit-app-registrations, self-healing-validation, test-authorization, security-scan]
    if: failure()

    steps:
      - name: Send Slack notification
        if: vars.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST ${{ vars.SLACK_WEBHOOK_URL }} \
            -H 'Content-type: application/json' \
            --data '{
              "text": ":warning: Identity Audit Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Identity & Security Audit Failed*\nEnvironment: `${{ github.event.inputs.environment || 'staging' }}`\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                  }
                }
              ]
            }'
