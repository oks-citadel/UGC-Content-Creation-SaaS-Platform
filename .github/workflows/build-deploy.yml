name: Build and Deploy to AKS

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  ACR_REGISTRY: acrmktstagingravs.azurecr.io
  AKS_CLUSTER: aks-marketing-staging-ravs
  AKS_RESOURCE_GROUP: marketing-staging-rg
  NAMESPACE: nexus-staging

jobs:
  build-backend:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - api-gateway
          - auth-service
          - user-service
          - campaign-service
          - content-service
          - creator-service
          - analytics-service
          - billing-service
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Login to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push ${{ matrix.service }}
        run: |
          docker build \
            -f services/${{ matrix.service }}/Dockerfile \
            -t ${{ env.ACR_REGISTRY }}/${{ matrix.service }}:${{ github.sha }} \
            -t ${{ env.ACR_REGISTRY }}/${{ matrix.service }}:latest \
            .
          docker push ${{ env.ACR_REGISTRY }}/${{ matrix.service }}:${{ github.sha }}
          docker push ${{ env.ACR_REGISTRY }}/${{ matrix.service }}:latest

  build-frontend:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app:
          - brand-portal
          - creator-portal
          - admin
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Login to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push ${{ matrix.app }}
        run: |
          docker build \
            -f apps/${{ matrix.app }}/Dockerfile \
            -t ${{ env.ACR_REGISTRY }}/${{ matrix.app }}:${{ github.sha }} \
            -t ${{ env.ACR_REGISTRY }}/${{ matrix.app }}:latest \
            .
          docker push ${{ env.ACR_REGISTRY }}/${{ matrix.app }}:${{ github.sha }}
          docker push ${{ env.ACR_REGISTRY }}/${{ matrix.app }}:latest

  deploy:
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AKS_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER }} \
            --overwrite-existing

      - name: Deploy to AKS
        run: |
          # Update image tags in manifests
          kubectl set image deployment/api-gateway \
            api-gateway=${{ env.ACR_REGISTRY }}/api-gateway:${{ github.sha }} \
            -n ${{ env.NAMESPACE }} || true

          kubectl set image deployment/auth-service \
            auth-service=${{ env.ACR_REGISTRY }}/auth-service:${{ github.sha }} \
            -n ${{ env.NAMESPACE }} || true

          kubectl set image deployment/brand-portal \
            brand-portal=${{ env.ACR_REGISTRY }}/brand-portal:${{ github.sha }} \
            -n ${{ env.NAMESPACE }} || true

          # Apply any new manifests
          kubectl apply -f infrastructure/kubernetes/overlays/staging/ \
            -n ${{ env.NAMESPACE }} || true

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/api-gateway -n ${{ env.NAMESPACE }} --timeout=300s || true
          kubectl get pods -n ${{ env.NAMESPACE }}
